<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>vita - vi in a textarea</title>
<style>
#vita * {
  font-family: monospace;
  border: none;
}
</style>
<head>
<body>

<form id="vita">
<textarea id="vi" rows="40" cols="80">
#include &lt;stdio.h&gt;

main() {
  printf("Hello, world!\n");
  return 0;
}
</textarea>
<input type="text" id="statusbar" />
</form>

<script>
var vi = document.getElementById('vi');
var statusbar = document.getElementById('statusbar');

var modes = {
  NORMAL: 0,
  INSERT: 1,
};

var nameFromMode = {};
nameFromMode[modes.NORMAL] = '';
nameFromMode[modes.INSERT] = '-- INSERT --';

// Not all of them are available via String.fromCharCode
var keys = {
  ESC: 27,
  A: 65,
  G: 71,
  H: 72,
  I: 73,
  J: 74,
  K: 75,
  L: 76,
  O: 79,
  Q: 81,
  '[': 219
}

var state = {
  mode: modes.NORMAL,
};

vi.onblur = function (e) {
  mode(modes.NORMAL);
};

function cursor(charIndex) {
  if (undefined === charIndex) {
    return vi.selectionStart;
  } else {
    vi.setSelectionRange(charIndex, charIndex);
    return charIndex;
  }
}

function mode(new_mode) {
  if (undefined === new_mode) {
    return state.mode;
  } else {
    state.mode = new_mode;
    statusbar.value = nameFromMode[new_mode];
    return state.mode;
  }
}

vi.onkeydown = function (e) {
  console.debug(e.keyCode);
  console.debug(mode());
  if (
      e.keyCode === keys.ESC
      || (e.ctrlKey && e.keyCode === keys['['])
    ) {
    mode(modes.NORMAL);
  }

  if (state.mode === modes.NORMAL) {
    e.preventDefault();

    switch (e.keyCode) {
      case keys.A:
      case keys.I:
      case keys.O:
        mode(modes.INSERT);
        break;

      case keys.G:
        if (e.shiftKey) {
          cursor(vi.value.length);
        } else {
          // NOTE this is Vim's 'gg' -- leaving it at one character for simplicity's sake right now
          cursor(0);
        }
        break;

      case keys.H:
        cursor(cursor() - 1);
        break;
      // case keys.J:
      // case keys.K:
      case keys.L:
        cursor(cursor() + 1);
        break;
    }
  }
};
</script>
</body>
</html>

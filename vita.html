<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>vita - vi in a textarea</title>
<style>
#vita * {
  font-family: monospace;
  border: none;
}
</style>
<head>
<body>

<form id="vita">
<textarea id="vi" rows="20" cols="80" autofocus="autofocus">
</textarea>
<input type="text" id="statusbar" />
</form>

<script>
var vi = document.getElementById('vi');
var statusbar = document.getElementById('statusbar');

var modes = {
  NORMAL: 0,
  INSERT: 1,
};

var nameFromMode = {};
nameFromMode[modes.NORMAL] = '';
nameFromMode[modes.INSERT] = '-- INSERT --';

// Not all of them are available via String.fromCharCode
var keys = {
  ESC: 27,
  0: 48,
  $: 52,
  A: 65,
  G: 71,
  H: 72,
  I: 73,
  J: 74,
  K: 75,
  L: 76,
  O: 79,
  Q: 81,
  '[': 219
}

var state = {
  mode: modes.NORMAL,
};

vi.onblur = function (e) {
  mode(modes.NORMAL);
};

//--
// FIXME this doesn't scroll the textarea if the cursor moves out of the visible area
function cursor(charIndex) {
  if (undefined === charIndex) {
    return vi.selectionStart;
  } else {
    vi.setSelectionRange(charIndex, charIndex);
    return charIndex;
  }
}

function mode(newMode) {
  if (undefined === newMode) {
    return state.mode;
  } else {
    state.mode = newMode;
    statusbar.value = nameFromMode[newMode];
    return state.mode;
  }
}

// Gives the beginning-of-line index for the given charIndex
function lineIndices(charIndex) {
  var lineLengths,
      lineNumber = 0,
      currentCharIndex = 0,
      i = 0,
      beginningOfThisLine = 0,
      beginningOfNextLine = 0;

  lineLengths = vi.value.
    split("\n").
    map(function(l) { return l.length + 1; });

  while (currentCharIndex <= charIndex) {
    currentCharIndex += lineLengths[lineNumber];
    lineNumber += 1;
  }

  for (i = 0; i < lineNumber; i += 1) {
    if (i + 1 < lineNumber) {
      beginningOfThisLine += lineLengths[i];
    }

    beginningOfNextLine += lineLengths[i];
  }

  return [beginningOfThisLine, beginningOfNextLine - 1];
}

function beginningOfLine() {
  return lineIndices(cursor())[0];
}

function endOfLine() {
  return lineIndices(cursor())[1];
}

vi.onkeydown = function (e) {
  if (
      e.keyCode === keys.ESC
      || (e.ctrlKey && e.keyCode === keys['['])
    ) {
    mode(modes.NORMAL);
  }

  if (state.mode === modes.NORMAL) {
    e.preventDefault();

    switch (e.keyCode) {
      case keys['0']:
        cursor(beginningOfLine());
        break;
      case keys.$:
        cursor(endOfLine());
        break;
      case keys.A:
        if (e.shiftKey) {
          cursor(endOfLine());
        } else {
          cursor(cursor + 1);
        }

        mode(modes.INSERT);
        break;
      case keys.I:
        if (e.shiftKey) {
          cursor(beginningOfLine());
        }

        mode(modes.INSERT);
        break;
      case keys.O:
        cursor(endOfLine() + 1);
        mode(modes.INSERT);
        break;

      case keys.G:
        if (e.shiftKey) {
          cursor(vi.value.length);
        } else {
          // NOTE this is Vim's 'gg' -- leaving it at one character for simplicity's sake right now
          cursor(0);
        }
        break;

      case keys.H:
        cursor(cursor() - 1);
        break;
      case keys.J:
        // Not quite, but close enough for now
        cursor(lineIndices(cursor())[1] + 1);
        break;
      case keys.K:
        // Not quite, but close enough for now
        cursor(lineIndices(cursor())[0] - 1);
        break;
      case keys.L:
        cursor(cursor() + 1);
        break;
    }
  }
};

// Have vita load itself :)
vi.value = document.getElementsByTagName('script')[0].innerHTML;
</script>
</body>
</html>
